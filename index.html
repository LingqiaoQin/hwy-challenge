<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css">
    <!--<link rel="stylesheet" href="https://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />-->
    <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" href="http://libs.cartodb.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
  </head>
  <body>
    <div class="torque-wrapper">
    	<h2 class="torque-header">
    		<div id="torque-timer">12:00 am EST</div>
			<div id="torque-saved-value"></div>
			<!--<div id="torque-saved-time"></div>-->
    	</h2>
    	<div class="torque-controls">
      		<div class="torque-pause" id="pause_button"></div>
      		<div class="torque-slider" id="slider">
      		</div>
      	</div>
      	<div id="map" class="maps"></div>
    </div>
    <div class="torque-wrapper">
    	<h2 class="torque-header">
    		<div id="torque-timer">12:00 am EST</div>
			<div id="torque-saved-value"></div>
			<!--<div id="torque-saved-time"></div>-->
    	</h2>
    	<div class="torque-controls">
      		<div class="torque-pause" id="pause_button"></div>
      		<div class="torque-slider" id="slider">
      		</div>
      	</div>
      	<div id="static_uber_map" class="maps"></div>
    </div>

    <!-- include cartodb.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
    <!--<script src="https://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>-->
    <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<script src="http://libs.cartodb.com/cartodb.js/v3/3.15/cartodb.js"></script>
    <script>


		  $(function() {
		    $("div#slider").slider({
		    		step:1,
		    		max:1021,
		    		min:0
				});
		  });

    	function main() {
		    
		    // Create Leaflet map object
		    var map = L.map('map',{ center: [42.362690, -71.081154], zoom: 12});
		    // Add Tile Layer basemap
		    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}.png', {
		    }).addTo(map);
			
		    var static_uber_map = L.map('static_uber_map',{ center: [42.362690, -71.081154], zoom: 12});

		    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}.png', {
		    }).addTo(static_uber_map);

			var torque_CARTOCSS = [
				'Map {',
				'-torque-time-attribute: "timestamp";',
				'-torque-aggregation-function: "avg(uber_value)";',
				'-torque-frame-count: 1021;',
				'-torque-animation-duration: 60;',
				'-torque-resolution: 1;',
				'-torque-data-aggregation: "linear";',
				'}',
				'#layer {',
				'  marker-width: 1;',
				'  marker-fill-opacity: 0.5;',
				'  comp-op: "lighter";',
				'}',
				'#layer[value <= 0] {',
				'  marker-fill: #ff0000;',
				'}',
				'#layer[value > 0] {',
				'  marker-fill: #44a93d;',
				'}',

			].join('\n');

			var static_CARTOCSS = [
				'#layer {',
				'  marker-width: 1;',
				'  marker-fill-opacity: .5;',
				'  marker-allow-overlap: true;',
				'  marker-fill: #ff0000;',
				'  marker-line-width: 0;',
				'}',
				'#layer[uber_value > 0] {',
				'  marker-fill: #44a93d;',
				'}',

			].join('\n');

			
			var torque_uber_layer = {
			    type: 'torque',
					options: {
						query: 'SELECT (uber_value_delta_raw + uber_duration_delta_raw*(.20 - 2)) AS uber_value, hubway_trips_uber_20160809.* FROM hubway_trips_uber_20160809',
						user_name: 'pateli18',
						table_name: 'hubway_trips_uber_20160809',
						cartocss: torque_CARTOCSS
					}
		  		}

		  	var static_uber_layer = {
		  		user_name: 'pateli18',
			    type: 'cartodb',
					sublayers: [{
						sql: 'SELECT * FROM hubway_trips_uber_20160809',
						/*sql: 'SELECT (uber_value_delta_raw + uber_duration_delta_raw*(.20 - 2)) AS uber_value, hubway_trips_uber_20160809.* FROM hubway_trips_uber_20160809',*/
						cartocss: static_CARTOCSS	
					}]
		  		}

		  	cartodb.createLayer(static_uber_map, static_uber_layer)
		  		.addTo(static_uber_map)
		  		.done(function(layer) {
		  		});

		  	cartodb.createLayer(map, torque_uber_layer, {time_slider:false})
				.addTo(map)
				.done(function(layer) {
					// add timer
          			layer.on('change:time', function(changes) {
          				datetime = changes["time"];
          				step = changes["step"];

          				$( "div#slider" ).slider( "value", step);

          				if (!isNaN(datetime)) {
	          				var hours_raw = datetime.getUTCHours();
							var minutes_raw = datetime.getUTCMinutes();
							var ampm = hours_raw >= 12 ? 'pm' : 'am';
							var hours = hours_raw % 12;
							hours = hours ? hours : 12; // the hour '0' should be '12'
							var minutes = minutes_raw < 10 ? '0'+minutes_raw : minutes_raw;
							var strTime = hours + ':' + minutes + ' ' + ampm + " EST";
	          				$("div#torque-timer").text(strTime);

	          				if(minutes_raw % 10 == 0) {
		          				minute_in_day = hours_raw * 60 + minutes_raw;
								uber_cost_sql_statement = 'SELECT SUM(saved_value_all) AS saved_value (SELECT AVG(uber_value) AS saved_value_all FROM (SELECT (uber_value_delta_raw + uber_duration_delta_raw*(.20 - 2)) AS uber_value, hubway_trips_uber_20160809.* FROM hubway_trips_uber_20160809 WHERE minute_in_day <= ' + minute_in_day + ') GROUP BY trip)';
								$.getJSON('https://pateli18.carto.com/api/v2/sql/?q='+uber_cost_sql_statement, function(data) {
									saved_value = data['rows'][0]['saved_value'];
									$("div#torque-saved-value").text('$' + saved_value.toLocaleString('en-US', {maximumFractionDigits:0}) + ' Value Saved');
								});
								/*
								uber_time_sql_statement = 'SELECT SUM(uber_duration_delta) AS saved_time FROM hubway_trips_20160809 WHERE minute_in_day <= ' + minute_in_day;
								$.getJSON('https://pateli18.carto.com/api/v2/sql/?q='+uber_time_sql_statement, function(data) {
									saved_time = data['rows'][0]['saved_time'] / 3600.0;
									$("div#torque-saved-time").text(saved_time.toLocaleString('en-US', {maximumFractionDigits:0}) + " Additional Hours");
								});
								*/
								
							}
						}
					});

					$( "div#slider" ).slider({
  						start: function( event, ui ) {
  							layer.pause();
  							$("#pause_button").removeClass("torque-pause");
  							$("#pause_button").addClass("torque-pause play");
  						}
					});

					$( "div#slider" ).slider({
  						slide: function( event, ui ) {
  							layer.setStep(ui.value);
  						}
					});

					$("#pause_button").click(function(){
						if (layer.isRunning()) {
							$(this).removeClass("torque-pause");
							$(this).addClass("torque-pause play");
							layer.pause();
						} else {
							$(this).removeClass("torque-pause play");
							$(this).addClass("torque-pause");
							layer.play();
						}
					});

				})
				.error(function(err) {
				console.log("Error: " + err);
				});
			}
		window.onload = main;
    </script>
  </body>
</html>
