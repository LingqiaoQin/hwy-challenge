<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>
  <body>
    <div id="torque-wrapper">
    	<h2 id="torque-header">
    		<div id="torque-time"></div>
			<div id="torque-count"></div>
    	</h2>
      <div id="map"></div>
    </div>

    <!-- include cartodb.js library -->
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
    <script>
    	function main() {
		    // Create Leaflet map object
		    var map = L.map('map',{ center: [42.362690, -71.081154], zoom: 12});
		    // Add Tile Layer basemap
		    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}.png', {
			attribution: 'CARTO'
		    }).addTo(map);

			var CARTOCSS = [
				'Map {',
				'-torque-time-attribute: "timestamp";',
				'-torque-aggregation-function: "count(1)";',
				'-torque-frame-count: 1021;',
				'-torque-animation-duration: 60;',
				'-torque-resolution: 1;',
				'-torque-data-aggregation: "linear";',
				'}',
				'#layer {',
				'  marker-width: 1;',
				'  marker-fill-opacity: 0.71;',
				'  marker-fill: #44a93d; ',
				'  comp-op: "lighter"',
				'}'
			].join('\n');

			var layerSource = {
			    type: 'torque',
					options: {
						user_name: 'pateli18',
						table_name: 'hubway_trips_20160809',
						cartocss: CARTOCSS
					}
		  		}

		  	cartodb.createLayer(map, layerSource)
				.addTo(map)
				.done(function(layer) {
					// add timer
          			layer.on('change:time', function(changes) {
          				datetime = changes["time"]
          				var hours = datetime.getUTCHours();
						var minutes = datetime.getUTCMinutes();
						var ampm = hours >= 12 ? 'pm' : 'am';
						hours = hours % 12;
						hours = hours ? hours : 12; // the hour '0' should be '12'
						minutes = minutes < 10 ? '0'+minutes : minutes;
						var strTime = hours + ':' + minutes + ' ' + ampm + " EST";
          				$("div#torque-time").text(strTime);

          				sql_statement = 'SELECT COUNT(DISTINCT(trip)) AS current_bikes FROM hubway_trips_20160809 WHERE EXTRACT(HOUR FROM timestamp) = ' + datetime.getUTCHours() + ' AND EXTRACT(MINUTE FROM timestamp) = ' + datetime.getUTCMinutes();
          				$.getJSON('https://pateli18.carto.com/api/v2/sql/?q='+sql_statement, function(data) {
          					$("div#torque-count").text(data['rows'][0]['current_bikes'] + ' Bikes');
          				});

          			});
				})
				.error(function(err) {
				console.log("Error: " + err);
				});
			}
		window.onload = main;
    </script>
  </body>
</html>
