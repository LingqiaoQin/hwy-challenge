<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>
  <body>
    <div class="torque-wrapper">
    	<h2 class="torque-header">
    		<div id="torque-timer">12:00 am EST</div>
			<div id="torque-saved-money"></div>
			<div id="torque-saved-time"></div>
    	</h2>
    	<div class="torque-controls">
      		<div class="torque-pause" id="pause_button"></div>
      		<div class="torque-slider" id="slider">
      		</div>
      	</div>
      	<div id="map"></div>
    </div>

    <!-- include cartodb.js library -->
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script>


		  $(function() {
		    $("div#slider").slider({
		    		step:1,
		    		max:1021,
		    		min:0
				});
		  });

    	function main() {
		    // Create Leaflet map object
		    var map = L.map('map',{ center: [42.362690, -71.081154], zoom: 12});
		    // Add Tile Layer basemap
		    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}.png', {
		    }).addTo(map);

			var CARTOCSS = [
				'Map {',
				'-torque-time-attribute: "timestamp";',
				'-torque-aggregation-function: "count(1)";',
				'-torque-frame-count: 1021;',
				'-torque-animation-duration: 60;',
				'-torque-resolution: 1;',
				'-torque-data-aggregation: "linear";',
				'}',
				'#layer {',
				'  marker-width: 1;',
				'  marker-fill-opacity: 0.71;',
				'  marker-fill: #44a93d; ',
				'  comp-op: "lighter";',
				'}'
			].join('\n');

			var layerSource = {
			    type: 'torque',
					options: {
						user_name: 'pateli18',
						table_name: 'hubway_trips_20160809',
						cartocss: CARTOCSS
					}
		  		}

		  	cartodb.createLayer(map, layerSource, {time_slider:false})
				.addTo(map)
				.done(function(layer) {
					// add timer
          			layer.on('change:time', function(changes) {
          				datetime = changes["time"];
          				step = changes["step"];

          				$( "div#slider" ).slider( "value", step);

          				if (!isNaN(datetime)) {
	          				var hours = datetime.getUTCHours();
							var minutes = datetime.getUTCMinutes();
							var ampm = hours >= 12 ? 'pm' : 'am';
							hours = hours % 12;
							hours = hours ? hours : 12; // the hour '0' should be '12'
							minutes = minutes < 10 ? '0'+minutes : minutes;
							var strTime = hours + ':' + minutes + ' ' + ampm + " EST";
	          				$("div#torque-timer").text(strTime);

	          				minute_in_day = datetime.getUTCHours() * 60 + datetime.getUTCMinutes();
	          				console.log(minute_in_day);
							uber_cost_sql_statement = 'SELECT SUM(uber_cost) AS saved_money FROM hubway_trips_20160809 WHERE minute_in_day <= ' + minute_in_day;
							$.getJSON('https://pateli18.carto.com/api/v2/sql/?q='+uber_cost_sql_statement, function(data) {
								saved_money = data['rows'][0]['saved_money'];
								$("div#torque-saved-money").text('$' + saved_money.toLocaleString('en-US', {maximumFractionDigits:0}) + ' Saved');
							});

							uber_time_sql_statement = 'SELECT SUM(uber_duration_delta) AS saved_time FROM hubway_trips_20160809 WHERE minute_in_day <= ' + minute_in_day;
							$.getJSON('https://pateli18.carto.com/api/v2/sql/?q='+uber_time_sql_statement, function(data) {
								saved_time = data['rows'][0]['saved_time'] / 3600.0;
								$("div#torque-saved-time").text(saved_time.toLocaleString('en-US', {maximumFractionDigits:0}) + " Hours Saved");
							});
						}
					});

					$( "div#slider" ).slider({
  						start: function( event, ui ) {
  							layer.pause();
  							$("#pause_button").removeClass("torque-pause");
  							$("#pause_button").addClass("torque-pause play");
  						}
					});

					$( "div#slider" ).slider({
  						slide: function( event, ui ) {
  							layer.setStep(ui.value);
  						}
					});

					$("#pause_button").click(function(){
						if (layer.isRunning()) {
							$(this).removeClass("torque-pause");
							$(this).addClass("torque-pause play");
							layer.pause();
						} else {
							$(this).removeClass("torque-pause play");
							$(this).addClass("torque-pause");
							layer.play();
						}
					});

				})
				.error(function(err) {
				console.log("Error: " + err);
				});
			}
		window.onload = main;
    </script>
  </body>
</html>
